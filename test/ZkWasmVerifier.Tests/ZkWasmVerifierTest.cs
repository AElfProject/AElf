using System.Threading.Tasks;
using AElf.Kernel.Blockchain.Application;
using AElf.Kernel.SmartContract;
using AElf.Kernel.SmartContract.Application;
using AElf.Types;
using Bn254.Net;
using Shouldly;
using Xunit;

namespace AElf.Contracts.ZkWasmVerifier;

public class ZkWasmVerifierTest : ZkWasmVerifierTestBase
{
    private readonly IBlockchainService _blockchainService;
    private readonly ISmartContractAddressNameProvider _smartContractAddressNameProvider;
    private readonly ISmartContractAddressService _smartContractAddressService;

    public ZkWasmVerifierTest()
    {
        _blockchainService = GetRequiredService<IBlockchainService>();
        _smartContractAddressService = GetRequiredService<ISmartContractAddressService>();
        _smartContractAddressNameProvider = GetRequiredService<ISmartContractAddressNameProvider>();
    }

    [Fact]
    public async Task ZkWasmVerifier_Verify_Test()
    {
        UInt256 x = 1;
        var result = await ZkWasmVerifierStub.Verify.SendAsync(GetInput());
        result.TransactionResult.Status.ShouldBe(TransactionResultStatus.Mined);
    }

    [Fact]
    public async Task ZkWasmVerifier_Verify_InvalidProof_Test()
    {
        var input = GetInput();
        var invalidProofValue0 = input.Proof[0].Replace("1", "2");
        input.Proof[0] = invalidProofValue0;
        var result = await ZkWasmVerifierStub.Verify.SendWithExceptionAsync(input);
        result.TransactionResult.Status.ShouldBe(TransactionResultStatus.Failed);
    }

    private VerifyInput GetInput()
    {
        var input = new VerifyInput();
        input.Proof.AddRange(Proof);
        input.Aux.AddRange(Aux);
        input.VerifyInstance.AddRange(VerifyInstance);
        var array = new VerifyInput.Types.StringArray();
        array.Value.AddRange(TargetInstance[0]);
        input.TargetInstance.Add(array);
        return input;
    }


    private static readonly string[] Proof =
    {
        "2047455918578351272295739148037510445970857435792147511947458949349602235524",
        "14613019117728727196389846614828678447254028582416251681370692663081461916707",
        "14004988626487830296424034024066487083326432231771215636084187121152376552986",
        "1845708091058724435132460762671524360872490184901525162060260996386897453496",
        "14865053302864499788020880232015402207723593257746485227511847891226446556268",
        "6050778834229151993995632819650199578977151612922227167629012266479508197357",
        "7247398036543288584744868144609299967827018505196732638557612054355562557757",
        "14820843344320245517954777225210415619779017831289309284820304770093287299542",
        "17220111216034560382139389971754597493656381893833027693812591253154659817100",
        "12257078599329533045959133228699117224224968420362099668518553651904272392037",
        "754324365026266544746903226387961984440145502705711662733650293994621386873",
        "8425664212938063540261975484673482943030132911868865230729985277811206062734",
        "2145051631393276616069554529622028095541308731133307938101167108861736891792",
        "11650952891140089525420143813340360982332939227089994730514013987142103305134",
        "1534149618756209744259236945384621112083269756399903023332440685147249413664",
        "10689210033585667149130279235630128183869397803480532590153350544682140577543",
        "12012716228124483911848779966344954887968588374990455969693439136345107438070",
        "8703749811034861512883936041468134041708338097072319285819667625485450329492",
        "9148506388491486985818674080091880528281856536294984767158038853262579177850",
        "9131577612172185691411249003019709978732309820829758888936368998282876526392",
        "15698547016516957129126550872918045912654950603434122673917458103743576094142",
        "10502037507661353551793470395857834490631046805340647435374847168753719846242",
        "20265989502270926126383688677078137695110870645179099138032266415847573914429",
        "8320061368951933579476195909676551701499852807497460007208123025015470199881",
        "1064451438392402973566372214895077603140055278947337654106618643802950793438",
        "17432890339321930513421276085009370788643639745950802011754634130068228049571",
        "7033885414080507186510456546853742759683940104073165166651147597240386824287",
        "9684792450714258946710202551324103009313690318120690461296375049808669136175",
        "17227276873403193999331004834630830545138094822793632068025462237862992341311",
        "19658226271641414001073194333677353742900735521698200380949017504091139026824",
        "19028444604357746560584721815725678449868544985072935815357860257503415001800",
        "20587425430213796833254503485466963561654015535363294624242781799095158518748",
        "1576385246402700991815947853037426187131115917049902959161427739224981420227",
        "11411878066317196295080418870230665022635919193764037938907504287435711369179",
        "2265106895031217232885616568394044555477418713672836442595446106477426506042",
        "3659363927780768356064277690773730204053428406897172404729596507094123881995",
        "2231975529856842512969088479192019809486841879142060483300395282045721575328",
        "16284666300692041756471543832444640987239471321710415721412673446276011965101",
        "9271131058185596043172377452360042289932560239531565998328972373161174581958",
        "16584552864273080348396922158554457466670910712902345044086088721254719673041",
        "9521706509514142073168671771732301614388828029708344781542279921379531572662",
        "15175420894181103874839111364506377218540035533851698608555974974882685266121",
        "6480720396422785815127480521967337309938844868733347034071747084826610290878",
        "4048149944482217266914702148148011300271649873798527377022265079708212173774",
        "13927293941037809452518392159572836717710165272474313941127722925190544578951",
        "16162597779377042211842313533279291501297074505940785690009139775763841936342",
        "1605110297295845365812174504471765715068008314040608561288838188241623175532",
        "7230991770161504143596570399134971268665851944725073287634875516543975618846",
        "8160261878994350714312051451567864527641120444675956448505006591349395378567",
        "2725942929873812855613593372551254651114652167932455240045176143741704002212",
        "11539330008054211814668506567766556279973928548534129187611725088642918675826",
        "18175774672080591637425752515648597211697816866003044716218276109524650434738",
        "13663960229500175160633152853640768053256114538682117211630591749040421760853",
        "3898955409337256318136140721028890627543652859620841620423009998276732572227",
        "9171953582125558689928756674058016122376556552298047046246629493490750373845",
        "2668431800801343845575965869159656051902799612668505368397264278189690345998",
        "4851676647113965337103630749062167688826474476083675056379629782375896016567",
        "7934358457318623835484957103096670546659539072184637336070618140058696263770",
        "12584903947348892113883645915059995533792362081930995807455531186619004137009",
        "18483112085508760859239216591954120536093469835400661899390664296560674142084",
        "6845549157140806648415626586059350218999622020649423788037167546709906967564",
        "14043974898989575426479164334998456273796001112122795669189675966021893055170",
        "1659235542078134834251378748749579470587783659233709015206764797433194275522",
        "3351388400715022943603459246882700374169909063382787804070630588520414536450",
        "7908726831869214742805663676860094437095156677217614077626521654670794380295",
        "7845311315474091041637265237864560306791830536648409278563018641748019496252",
        "1125825741383405943865848980383128287138913807595948028006708651492701740580",
        "4443938355136372755097508713953515333910295790660601565032575597863273433036",
        "12847839286485261036638434951037506922444116067776293924513149014757883263119",
        "3789758999188302797193883342335519853019468124193597748445169373782640645245",
        "21647622154326072780946655332038196210961173386491789026519933591527885656447",
        "8019253739945670777406605429268135105532709330101744386030273715022515972620",
        "15646207604620564271553083449418012669439226452099593798034744356700196609257",
        "20935393669299658225205288641778692475407981410260234531866421235617900689839",
        "7383620108539696478561942637234374352503053017875473844419495911612447827824",
        "20958842966930955158015148278399396953367990476018531056167906283020217327202",
        "18875234096765218586921426898797043197282523763927227061410099333154557276785",
        "13712407928905742799964970654013362017404663111832813167180686727328903623836",
        "15900061058241232687877487757131933000942269267109748840131136576904544351620",
        "11989843573485423660655738010399615061795105718203188938114856157707967621974",
        "7902922889181130859829985602790647943213718674565947069786529983120269626621",
        "21068421876524405225225650154004993119250409963732747269076658456025127631235",
        "14230146533402215640805915584957767775731193521386588539758761393598883536407",
        "15018217441868151830033176865346875523009846464232753962615362562959543701670",
        "18204814997152988383471726849600616681202850573932109665805373641429013130640",
        "20993160107254488761092229354618841972862220189733632619653482764464248103859",
        "7887312335486266927082829417179001034109955003733587812427302250730677710830",
        "15272696422767648140791646154096997078092772322712543184291848264764656988850",
        "5990449655025411247630003434173704271976394045919716348144044615434382624618",
        "6562425776879227910016819921144684631793232660881722531646048293707481167923",
        "9964416295801242377042589355656995427312105092573876144964369720900713602047",
        "20823255345114259725827338349119345322307944832411531219665621259431136553266",
        "21332737532972562199157360654530217111569931371944989219298323186437447204995",
        "19061572835756508957681414024323720390049749685136568544052750247100711182334",
        "16192331436763176224194832884595295223618072204689943402973848545842295869747",
        "14450146033726786685944403813872902233944103607717238654591715388128801653775",
        "2643920433670728249335838940943357596325842712738630883996520748124360059647",
        "12683284841363166633379131009214046573937400838864656800575341300704629547380",
        "6343202408334267660686281399990887415732029426284534937800544429250790744462",
        "20620363317685904242398136197134828658126318295943655230944663196828544662395",
        "14580276190765060143025725681974685899259788185725652233034953197839688735902",
        "10829528751850070054813744048883067395224621937364413008513199893493458868613",
        "6481848982124033628341922477385470846823628781101033304013533554919608210377",
        "11515919385735912766265075030892475885033544479989546076007569102813813725931"
    };

    private static readonly string[] VerifyInstance =
    {
        "4326362218662338043640258102480184848682926335642248513547536048823698549238",
        "95525476947340616796268351144141608139131414305524311083271820054",
        "61196919336403281145059960132947612714925057307263736304990550048",
        "52765369756462887768127481588656359817904477"
    };

    private static readonly string[] Aux =
    {
        "16372965556492133599189737490111823933638593726409724431768127367369072545938",
        "9923254564196213579748208009695877807814573704529505906646847686222751838294",
        "5515277315347141623056668255145451154909770674006309911930076819206735949679",
        "4690948235056819942566421166428921543624707898734273609845117857394419759013",
        "11964988307643061642498197735561397280733790695886528437051356500353056657323",
        "17197294636782455279679984578828353544923656501681760733853086329181388736604",
        "6864820496573103273052335609143589283944436369338443952476126999787638321810",
        "15023422375266171949194070136113685804603928031077590391222077186788170173807",
        "9156181127771348114505178421548726333137994260436107058546255772149845526310",
        "19315228919774089044434742345001771197735708371388996716547261328606574127346",
        "7515620530091903958189715213447918324435604530821355880240601851788893098714",
        "15855324919034141424572167120731769048626133435180925895050366117693401188928",
        "15568950565033783144429792273067550142429266715697525195283863944752048189310",
        "12468562863441495074481345634168979598461089611548738245267576534251774121718",
        "9688867635228923704181276864119507786702150911244491725439170446126819753061",
        "20044895013261168209775045584350039737368237871862344527369683154800473228508",
        "3761920823592744489848225710735638997724237551618360975430766337838856033028",
        "4722959272949643732326915566844926314510845431219015478081393489208561285197",
        "14043609948791593790866837520790358250955550466324230040502579680400864471510",
        "17165283598889631489919490178412348774037518969197018865616810697367247210420",
        "7844632923047681431379568224466916837592813934091804303195624506174944024107",
    };

    private static readonly string[][] TargetInstance =
    {
        new[] { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" }
    };
}