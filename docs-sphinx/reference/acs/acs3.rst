ACS3 - Contract Proposal Standard
=================================

ACS3 is suitable for the case that a method needs to be approved by
multiple parties. At this time, you can consider using some of the
interfaces provided by ACS3.

Interface
---------

If you want multiple addresses vote to get agreement to do something,
you can implement the following methods defined in ACS3:

Methods
~~~~~~~

+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Method Name                           | Request Type                                                                               | Response Type                                                | Description                                                                                                                                                                                                                           |
+=======================================+============================================================================================+==============================================================+=======================================================================================================================================================================================================================================+
| CreateProposal                        | `acs3.CreateProposalInput <#acs3.CreateProposalInput>`__                                   | `aelf.Hash <#aelf.Hash>`__                                   | Create a proposal for which organization members can vote. When the proposal is released, a transaction will be sent to the specified contract. Return id of the newly created proposal.                                              |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Approve                               | `aelf.Hash <#aelf.Hash>`__                                                                 | `google.protobuf.Empty <#google.protobuf.Empty>`__           | Approve a proposal according to the proposal ID.                                                                                                                                                                                      |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Reject                                | `aelf.Hash <#aelf.Hash>`__                                                                 | `google.protobuf.Empty <#google.protobuf.Empty>`__           | Reject a proposal according to the proposal ID.                                                                                                                                                                                       |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Abstain                               | `aelf.Hash <#aelf.Hash>`__                                                                 | `google.protobuf.Empty <#google.protobuf.Empty>`__           | Abstain a proposal according to the proposal ID.                                                                                                                                                                                      |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Release                               | `aelf.Hash <#aelf.Hash>`__                                                                 | `google.protobuf.Empty <#google.protobuf.Empty>`__           | Release a proposal according to the proposal ID and send a transaction to the specified contract.                                                                                                                                     |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ChangeOrganizationThreshold           | `acs3.ProposalReleaseThreshold <#acs3.ProposalReleaseThreshold>`__                         | `google.protobuf.Empty <#google.protobuf.Empty>`__           | Change the thresholds associated with proposals. All fields will be overwritten by the input value and this will affect all current proposals of the organization. Note: only the organization can execute this through a proposal.   |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ChangeOrganizationProposerWhiteList   | `acs3.ProposerWhiteList <#acs3.ProposerWhiteList>`__                                       | `google.protobuf.Empty <#google.protobuf.Empty>`__           | Change the white list of organization proposer. This method overrides the list of whitelisted proposers.                                                                                                                              |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| CreateProposalBySystemContract        | `acs3.CreateProposalBySystemContractInput <#acs3.CreateProposalBySystemContractInput>`__   | `aelf.Hash <#aelf.Hash>`__                                   | Create a proposal by system contracts, and return id of the newly created proposal.                                                                                                                                                   |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ClearProposal                         | `aelf.Hash <#aelf.Hash>`__                                                                 | `google.protobuf.Empty <#google.protobuf.Empty>`__           | Remove the specified proposal. If the proposal is in effect, the cleanup fails.                                                                                                                                                       |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| GetProposal                           | `aelf.Hash <#aelf.Hash>`__                                                                 | `acs3.ProposalOutput <#acs3.ProposalOutput>`__               | Get the proposal according to the proposal ID.                                                                                                                                                                                        |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ValidateOrganizationExist             | `aelf.Address <#aelf.Address>`__                                                           | `google.protobuf.BoolValue <#google.protobuf.BoolValue>`__   | Check the existence of an organization.                                                                                                                                                                                               |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ValidateProposerInWhiteList           | `acs3.ValidateProposerInWhiteListInput <#acs3.ValidateProposerInWhiteListInput>`__         | `google.protobuf.BoolValue <#google.protobuf.BoolValue>`__   | Check if the proposer is whitelisted.                                                                                                                                                                                                 |
+---------------------------------------+--------------------------------------------------------------------------------------------+--------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

Types
~~~~~

.. raw:: html

   <div id="acs3.CreateProposalBySystemContractInput">

.. raw:: html

   </div>

acs3.CreateProposalBySystemContractInput
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+--------------------+-------------------------------------------------------+----------------------------------------+---------+
| Field              | Type                                                  | Description                            | Label   |
+====================+=======================================================+========================================+=========+
| proposal\_input    | `CreateProposalInput <#acs3.CreateProposalInput>`__   | The parameters of creating proposal.   |         |
+--------------------+-------------------------------------------------------+----------------------------------------+---------+
| origin\_proposer   | `aelf.Address <#aelf.Address>`__                      | The actor that trigger the call.       |         |
+--------------------+-------------------------------------------------------+----------------------------------------+---------+

.. raw:: html

   <div id="acs3.CreateProposalInput">

.. raw:: html

   </div>

acs3.CreateProposalInput
^^^^^^^^^^^^^^^^^^^^^^^^

+------------------------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+---------+
| Field                        | Type                                                         | Description                                                                                                    | Label   |
+==============================+==============================================================+================================================================================================================+=========+
| contract\_method\_name       | `string <#string>`__                                         | The name of the method to call after release.                                                                  |         |
+------------------------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+---------+
| to\_address                  | `aelf.Address <#aelf.Address>`__                             | The address of the contract to call after release.                                                             |         |
+------------------------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+---------+
| params                       | `bytes <#bytes>`__                                           | The parameter of the method to be called after the release.                                                    |         |
+------------------------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+---------+
| expired\_time                | `google.protobuf.Timestamp <#google.protobuf.Timestamp>`__   | The timestamp at which this proposal will expire.                                                              |         |
+------------------------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+---------+
| organization\_address        | `aelf.Address <#aelf.Address>`__                             | The address of the organization.                                                                               |         |
+------------------------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+---------+
| proposal\_description\_url   | `string <#string>`__                                         | Url is used for proposal describing.                                                                           |         |
+------------------------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+---------+
| token                        | `aelf.Hash <#aelf.Hash>`__                                   | The token is for proposal id generation and with this token, proposal id can be calculated before proposing.   |         |
+------------------------------+--------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+---------+

.. raw:: html

   <div id="acs3.OrganizationCreated">

.. raw:: html

   </div>

acs3.OrganizationCreated
^^^^^^^^^^^^^^^^^^^^^^^^

+-------------------------+------------------------------------+--------------------------------------------+---------+
| Field                   | Type                               | Description                                | Label   |
+=========================+====================================+============================================+=========+
| organization\_address   | `aelf.Address <#aelf.Address>`__   | The address of the created organization.   |         |
+-------------------------+------------------------------------+--------------------------------------------+---------+

.. raw:: html

   <div id="acs3.OrganizationHashAddressPair">

.. raw:: html

   </div>

acs3.OrganizationHashAddressPair
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+-------------------------+------------------------------------+--------------------------------+---------+
| Field                   | Type                               | Description                    | Label   |
+=========================+====================================+================================+=========+
| organization\_hash      | `aelf.Hash <#aelf.Hash>`__         | The id of organization.        |         |
+-------------------------+------------------------------------+--------------------------------+---------+
| organization\_address   | `aelf.Address <#aelf.Address>`__   | The address of organization.   |         |
+-------------------------+------------------------------------+--------------------------------+---------+

.. raw:: html

   <div id="acs3.OrganizationThresholdChanged">

.. raw:: html

   </div>

acs3.OrganizationThresholdChanged
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+--------------------------------+-----------------------------------------------------------------+------------------------------+---------+
| Field                          | Type                                                            | Description                  | Label   |
+================================+=================================================================+==============================+=========+
| organization\_address          | `aelf.Address <#aelf.Address>`__                                | The organization address     |         |
+--------------------------------+-----------------------------------------------------------------+------------------------------+---------+
| proposer\_release\_threshold   | `ProposalReleaseThreshold <#acs3.ProposalReleaseThreshold>`__   | The new release threshold.   |         |
+--------------------------------+-----------------------------------------------------------------+------------------------------+---------+

.. raw:: html

   <div id="acs3.OrganizationWhiteListChanged">

.. raw:: html

   </div>

acs3.OrganizationWhiteListChanged
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+-------------------------+---------------------------------------------------+-------------------------------+---------+
| Field                   | Type                                              | Description                   | Label   |
+=========================+===================================================+===============================+=========+
| organization\_address   | `aelf.Address <#aelf.Address>`__                  | The organization address.     |         |
+-------------------------+---------------------------------------------------+-------------------------------+---------+
| proposer\_white\_list   | `ProposerWhiteList <#acs3.ProposerWhiteList>`__   | The new proposer whitelist.   |         |
+-------------------------+---------------------------------------------------+-------------------------------+---------+

.. raw:: html

   <div id="acs3.ProposalCreated">

.. raw:: html

   </div>

acs3.ProposalCreated
^^^^^^^^^^^^^^^^^^^^

+-------------------------+------------------------------------+-----------------------------------------------------+---------+
| Field                   | Type                               | Description                                         | Label   |
+=========================+====================================+=====================================================+=========+
| proposal\_id            | `aelf.Hash <#aelf.Hash>`__         | The id of the created proposal.                     |         |
+-------------------------+------------------------------------+-----------------------------------------------------+---------+
| organization\_address   | `aelf.Address <#aelf.Address>`__   | The organization address of the created proposal.   |         |
+-------------------------+------------------------------------+-----------------------------------------------------+---------+

.. raw:: html

   <div id="acs3.ProposalOutput">

.. raw:: html

   </div>

acs3.ProposalOutput
^^^^^^^^^^^^^^^^^^^

+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+
| Field                    | Type                                                         | Description                                                    | Label   |
+==========================+==============================================================+================================================================+=========+
| proposal\_id             | `aelf.Hash <#aelf.Hash>`__                                   | The id of the proposal.                                        |         |
+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+
| contract\_method\_name   | `string <#string>`__                                         | The method that this proposal will call when being released.   |         |
+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+
| to\_address              | `aelf.Address <#aelf.Address>`__                             | The address of the target contract.                            |         |
+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+
| params                   | `bytes <#bytes>`__                                           | The parameters of the release transaction.                     |         |
+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+
| expired\_time            | `google.protobuf.Timestamp <#google.protobuf.Timestamp>`__   | The date at which this proposal will expire.                   |         |
+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+
| organization\_address    | `aelf.Address <#aelf.Address>`__                             | The address of this proposals organization.                    |         |
+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+
| proposer                 | `aelf.Address <#aelf.Address>`__                             | The address of the proposer of this proposal.                  |         |
+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+
| to\_be\_released         | `bool <#bool>`__                                             | Indicates if this proposal is releasable.                      |         |
+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+
| approval\_count          | `int64 <#int64>`__                                           | Approval count for this proposal.                              |         |
+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+
| rejection\_count         | `int64 <#int64>`__                                           | Rejection count for this proposal.                             |         |
+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+
| abstention\_count        | `int64 <#int64>`__                                           | Abstention count for this proposal.                            |         |
+--------------------------+--------------------------------------------------------------+----------------------------------------------------------------+---------+

.. raw:: html

   <div id="acs3.ProposalReleaseThreshold">

.. raw:: html

   </div>

acs3.ProposalReleaseThreshold
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+----------------------------------+----------------------+---------------------------------------------------+---------+
| Field                            | Type                 | Description                                       | Label   |
+==================================+======================+===================================================+=========+
| minimal\_approval\_threshold     | `int64 <#int64>`__   | The value for the minimum approval threshold.     |         |
+----------------------------------+----------------------+---------------------------------------------------+---------+
| maximal\_rejection\_threshold    | `int64 <#int64>`__   | The value for the maximal rejection threshold.    |         |
+----------------------------------+----------------------+---------------------------------------------------+---------+
| maximal\_abstention\_threshold   | `int64 <#int64>`__   | The value for the maximal abstention threshold.   |         |
+----------------------------------+----------------------+---------------------------------------------------+---------+
| minimal\_vote\_threshold         | `int64 <#int64>`__   | The value for the minimal vote threshold.         |         |
+----------------------------------+----------------------+---------------------------------------------------+---------+

.. raw:: html

   <div id="acs3.ProposalReleased">

.. raw:: html

   </div>

acs3.ProposalReleased
^^^^^^^^^^^^^^^^^^^^^

+-------------------------+------------------------------------+------------------------------------------------------+---------+
| Field                   | Type                               | Description                                          | Label   |
+=========================+====================================+======================================================+=========+
| proposal\_id            | `aelf.Hash <#aelf.Hash>`__         | The id of the released proposal.                     |         |
+-------------------------+------------------------------------+------------------------------------------------------+---------+
| organization\_address   | `aelf.Address <#aelf.Address>`__   | The organization address of the released proposal.   |         |
+-------------------------+------------------------------------+------------------------------------------------------+---------+

.. raw:: html

   <div id="acs3.ProposerWhiteList">

.. raw:: html

   </div>

acs3.ProposerWhiteList
^^^^^^^^^^^^^^^^^^^^^^

+-------------+------------------------------------+--------------------------------+------------+
| Field       | Type                               | Description                    | Label      |
+=============+====================================+================================+============+
| proposers   | `aelf.Address <#aelf.Address>`__   | The address of the proposers   | repeated   |
+-------------+------------------------------------+--------------------------------+------------+

.. raw:: html

   <div id="acs3.ReceiptCreated">

.. raw:: html

   </div>

acs3.ReceiptCreated
^^^^^^^^^^^^^^^^^^^

+-------------------------+--------------------------------------------------------------+----------------------------------------------------+---------+
| Field                   | Type                                                         | Description                                        | Label   |
+=========================+==============================================================+====================================================+=========+
| proposal\_id            | `aelf.Hash <#aelf.Hash>`__                                   | The id of the proposal.                            |         |
+-------------------------+--------------------------------------------------------------+----------------------------------------------------+---------+
| address                 | `aelf.Address <#aelf.Address>`__                             | The sender address.                                |         |
+-------------------------+--------------------------------------------------------------+----------------------------------------------------+---------+
| receipt\_type           | `string <#string>`__                                         | The type of receipt(Approve, Reject or Abstain).   |         |
+-------------------------+--------------------------------------------------------------+----------------------------------------------------+---------+
| time                    | `google.protobuf.Timestamp <#google.protobuf.Timestamp>`__   | The timestamp of this method call.                 |         |
+-------------------------+--------------------------------------------------------------+----------------------------------------------------+---------+
| organization\_address   | `aelf.Address <#aelf.Address>`__                             | The address of the organization.                   |         |
+-------------------------+--------------------------------------------------------------+----------------------------------------------------+---------+

.. raw:: html

   <div id="acs3.ValidateProposerInWhiteListInput">

.. raw:: html

   </div>

acs3.ValidateProposerInWhiteListInput
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+-------------------------+------------------------------------+------------------------------------+---------+
| Field                   | Type                               | Description                        | Label   |
+=========================+====================================+====================================+=========+
| proposer                | `aelf.Address <#aelf.Address>`__   | The address to search/check.       |         |
+-------------------------+------------------------------------+------------------------------------+---------+
| organization\_address   | `aelf.Address <#aelf.Address>`__   | The address of the organization.   |         |
+-------------------------+------------------------------------+------------------------------------+---------+

.. raw:: html

   <div id="aelf.Address">

.. raw:: html

   </div>

aelf.Address
^^^^^^^^^^^^

+---------+----------------------+---------------+---------+
| Field   | Type                 | Description   | Label   |
+=========+======================+===============+=========+
| value   | `bytes <#bytes>`__   |               |         |
+---------+----------------------+---------------+---------+

.. raw:: html

   <div id="aelf.BinaryMerkleTree">

.. raw:: html

   </div>

aelf.BinaryMerkleTree
^^^^^^^^^^^^^^^^^^^^^

+---------------+-------------------------+---------------------------+------------+
| Field         | Type                    | Description               | Label      |
+===============+=========================+===========================+============+
| nodes         | `Hash <#aelf.Hash>`__   | The leaf nodes.           | repeated   |
+---------------+-------------------------+---------------------------+------------+
| root          | `Hash <#aelf.Hash>`__   | The root node hash.       |            |
+---------------+-------------------------+---------------------------+------------+
| leaf\_count   | `int32 <#int32>`__      | The count of leaf node.   |            |
+---------------+-------------------------+---------------------------+------------+

.. raw:: html

   <div id="aelf.Hash">

.. raw:: html

   </div>

aelf.Hash
^^^^^^^^^

+---------+----------------------+---------------+---------+
| Field   | Type                 | Description   | Label   |
+=========+======================+===============+=========+
| value   | `bytes <#bytes>`__   |               |         |
+---------+----------------------+---------------+---------+

.. raw:: html

   <div id="aelf.LogEvent">

.. raw:: html

   </div>

aelf.LogEvent
^^^^^^^^^^^^^

+----------------+-------------------------------+----------------------------------------------+------------+
| Field          | Type                          | Description                                  | Label      |
+================+===============================+==============================================+============+
| address        | `Address <#aelf.Address>`__   | The contract address.                        |            |
+----------------+-------------------------------+----------------------------------------------+------------+
| name           | `string <#string>`__          | The name of the log event.                   |            |
+----------------+-------------------------------+----------------------------------------------+------------+
| indexed        | `bytes <#bytes>`__            | The indexed data, used to calculate bloom.   | repeated   |
+----------------+-------------------------------+----------------------------------------------+------------+
| non\_indexed   | `bytes <#bytes>`__            | The non indexed data.                        |            |
+----------------+-------------------------------+----------------------------------------------+------------+

.. raw:: html

   <div id="aelf.MerklePath">

.. raw:: html

   </div>

aelf.MerklePath
^^^^^^^^^^^^^^^

+-----------------------+---------------------------------------------+--------------------------+------------+
| Field                 | Type                                        | Description              | Label      |
+=======================+=============================================+==========================+============+
| merkle\_path\_nodes   | `MerklePathNode <#aelf.MerklePathNode>`__   | The merkle path nodes.   | repeated   |
+-----------------------+---------------------------------------------+--------------------------+------------+

.. raw:: html

   <div id="aelf.MerklePathNode">

.. raw:: html

   </div>

aelf.MerklePathNode
^^^^^^^^^^^^^^^^^^^

+-------------------------+-------------------------+------------------------------------+---------+
| Field                   | Type                    | Description                        | Label   |
+=========================+=========================+====================================+=========+
| hash                    | `Hash <#aelf.Hash>`__   | The node hash.                     |         |
+-------------------------+-------------------------+------------------------------------+---------+
| is\_left\_child\_node   | `bool <#bool>`__        | Whether it is a left child node.   |         |
+-------------------------+-------------------------+------------------------------------+---------+

.. raw:: html

   <div id="aelf.SInt32Value">

.. raw:: html

   </div>

aelf.SInt32Value
^^^^^^^^^^^^^^^^

+---------+------------------------+---------------+---------+
| Field   | Type                   | Description   | Label   |
+=========+========================+===============+=========+
| value   | `sint32 <#sint32>`__   |               |         |
+---------+------------------------+---------------+---------+

.. raw:: html

   <div id="aelf.SInt64Value">

.. raw:: html

   </div>

aelf.SInt64Value
^^^^^^^^^^^^^^^^

+---------+------------------------+---------------+---------+
| Field   | Type                   | Description   | Label   |
+=========+========================+===============+=========+
| value   | `sint64 <#sint64>`__   |               |         |
+---------+------------------------+---------------+---------+

.. raw:: html

   <div id="aelf.ScopedStatePath">

.. raw:: html

   </div>

aelf.ScopedStatePath
^^^^^^^^^^^^^^^^^^^^

+-----------+-----------------------------------+----------------------------------------------------------+---------+
| Field     | Type                              | Description                                              | Label   |
+===========+===================================+==========================================================+=========+
| address   | `Address <#aelf.Address>`__       | The scope address, which will be the contract address.   |         |
+-----------+-----------------------------------+----------------------------------------------------------+---------+
| path      | `StatePath <#aelf.StatePath>`__   | The path of contract state.                              |         |
+-----------+-----------------------------------+----------------------------------------------------------+---------+

.. raw:: html

   <div id="aelf.SmartContractRegistration">

.. raw:: html

   </div>

aelf.SmartContractRegistration
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+------------------------+-------------------------+-----------------------------------------+---------+
| Field                  | Type                    | Description                             | Label   |
+========================+=========================+=========================================+=========+
| category               | `sint32 <#sint32>`__    | The category of contract code(0: C#).   |         |
+------------------------+-------------------------+-----------------------------------------+---------+
| code                   | `bytes <#bytes>`__      | The byte array of the contract code.    |         |
+------------------------+-------------------------+-----------------------------------------+---------+
| code\_hash             | `Hash <#aelf.Hash>`__   | The hash of the contract code.          |         |
+------------------------+-------------------------+-----------------------------------------+---------+
| is\_system\_contract   | `bool <#bool>`__        | Whether it is a system contract.        |         |
+------------------------+-------------------------+-----------------------------------------+---------+
| version                | `int32 <#int32>`__      | The version of the current contract.    |         |
+------------------------+-------------------------+-----------------------------------------+---------+

.. raw:: html

   <div id="aelf.StatePath">

.. raw:: html

   </div>

aelf.StatePath
^^^^^^^^^^^^^^

+---------+------------------------+---------------------------------------+------------+
| Field   | Type                   | Description                           | Label      |
+=========+========================+=======================================+============+
| parts   | `string <#string>`__   | The partial path of the state path.   | repeated   |
+---------+------------------------+---------------------------------------+------------+

.. raw:: html

   <div id="aelf.Transaction">

.. raw:: html

   </div>

aelf.Transaction
^^^^^^^^^^^^^^^^

+----------------------+-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
| Field                | Type                          | Description                                                                                                                                                                                        | Label   |
+======================+===============================+====================================================================================================================================================================================================+=========+
| from                 | `Address <#aelf.Address>`__   | The address of the sender of the transaction.                                                                                                                                                      |         |
+----------------------+-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
| to                   | `Address <#aelf.Address>`__   | The address of the contract when calling a contract.                                                                                                                                               |         |
+----------------------+-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
| ref\_block\_number   | `int64 <#int64>`__            | The height of the referenced block hash.                                                                                                                                                           |         |
+----------------------+-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
| ref\_block\_prefix   | `bytes <#bytes>`__            | The first four bytes of the referenced block hash.                                                                                                                                                 |         |
+----------------------+-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
| method\_name         | `string <#string>`__          | The name of a method in the smart contract at the To address.                                                                                                                                      |         |
+----------------------+-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
| params               | `bytes <#bytes>`__            | The parameters to pass to the smart contract method.                                                                                                                                               |         |
+----------------------+-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
| signature            | `bytes <#bytes>`__            | When signing a transaction it’s actually a subset of the fields: from/to and the target method as well as the parameter that were given. It also contains the reference block number and prefix.   |         |
+----------------------+-------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+

.. raw:: html

   <div id="aelf.TransactionExecutingStateSet">

.. raw:: html

   </div>

aelf.TransactionExecutingStateSet
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+-----------+---------------------------------------------------------------------------------------------------+-----------------------+------------+
| Field     | Type                                                                                              | Description           | Label      |
+===========+===================================================================================================+=======================+============+
| writes    | `TransactionExecutingStateSet.WritesEntry <#aelf.TransactionExecutingStateSet.WritesEntry>`__     | The changed states.   | repeated   |
+-----------+---------------------------------------------------------------------------------------------------+-----------------------+------------+
| reads     | `TransactionExecutingStateSet.ReadsEntry <#aelf.TransactionExecutingStateSet.ReadsEntry>`__       | The read states.      | repeated   |
+-----------+---------------------------------------------------------------------------------------------------+-----------------------+------------+
| deletes   | `TransactionExecutingStateSet.DeletesEntry <#aelf.TransactionExecutingStateSet.DeletesEntry>`__   | The deleted states.   | repeated   |
+-----------+---------------------------------------------------------------------------------------------------+-----------------------+------------+

.. raw:: html

   <div id="aelf.TransactionExecutingStateSet.DeletesEntry">

.. raw:: html

   </div>

aelf.TransactionExecutingStateSet.DeletesEntry
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+---------+------------------------+---------------+---------+
| Field   | Type                   | Description   | Label   |
+=========+========================+===============+=========+
| key     | `string <#string>`__   |               |         |
+---------+------------------------+---------------+---------+
| value   | `bool <#bool>`__       |               |         |
+---------+------------------------+---------------+---------+

.. raw:: html

   <div id="aelf.TransactionExecutingStateSet.ReadsEntry">

.. raw:: html

   </div>

aelf.TransactionExecutingStateSet.ReadsEntry
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+---------+------------------------+---------------+---------+
| Field   | Type                   | Description   | Label   |
+=========+========================+===============+=========+
| key     | `string <#string>`__   |               |         |
+---------+------------------------+---------------+---------+
| value   | `bool <#bool>`__       |               |         |
+---------+------------------------+---------------+---------+

.. raw:: html

   <div id="aelf.TransactionExecutingStateSet.WritesEntry">

.. raw:: html

   </div>

aelf.TransactionExecutingStateSet.WritesEntry
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+---------+------------------------+---------------+---------+
| Field   | Type                   | Description   | Label   |
+=========+========================+===============+=========+
| key     | `string <#string>`__   |               |         |
+---------+------------------------+---------------+---------+
| value   | `bytes <#bytes>`__     |               |         |
+---------+------------------------+---------------+---------+

.. raw:: html

   <div id="aelf.TransactionResult">

.. raw:: html

   </div>

aelf.TransactionResult
^^^^^^^^^^^^^^^^^^^^^^

+-------------------+---------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+
| Field             | Type                                                          | Description                                                                                                                                                                                                                                                                | Label      |
+===================+===============================================================+============================================================================================================================================================================================================================================================================+============+
| transaction\_id   | `Hash <#aelf.Hash>`__                                         | The transaction id.                                                                                                                                                                                                                                                        |            |
+-------------------+---------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+
| status            | `TransactionResultStatus <#aelf.TransactionResultStatus>`__   | The transaction result status.                                                                                                                                                                                                                                             |            |
+-------------------+---------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+
| logs              | `LogEvent <#aelf.LogEvent>`__                                 | The log events.                                                                                                                                                                                                                                                            | repeated   |
+-------------------+---------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+
| bloom             | `bytes <#bytes>`__                                            | Bloom filter for transaction logs. A transaction log event can be defined in the contract and stored in the bloom filter after the transaction is executed. Through this filter, we can quickly search for and determine whether a log exists in the transaction result.   |            |
+-------------------+---------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+
| return\_value     | `bytes <#bytes>`__                                            | The return value of the transaction execution.                                                                                                                                                                                                                             |            |
+-------------------+---------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+
| block\_number     | `int64 <#int64>`__                                            | The height of the block hat packages the transaction.                                                                                                                                                                                                                      |            |
+-------------------+---------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+
| block\_hash       | `Hash <#aelf.Hash>`__                                         | The hash of the block hat packages the transaction.                                                                                                                                                                                                                        |            |
+-------------------+---------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+
| error             | `string <#string>`__                                          | Failed execution error message.                                                                                                                                                                                                                                            |            |
+-------------------+---------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+

.. raw:: html

   <div id="aelf.TransactionResultStatus">

.. raw:: html

   </div>

aelf.TransactionResultStatus
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+----------------------------+----------+-------------------------------------------------------------------------------------+
| Name                       | Number   | Description                                                                         |
+============================+==========+=====================================================================================+
| NOT\_EXISTED               | 0        | The execution result of the transaction does not exist.                             |
+----------------------------+----------+-------------------------------------------------------------------------------------+
| PENDING                    | 1        | The transaction is in the transaction pool waiting to be packaged.                  |
+----------------------------+----------+-------------------------------------------------------------------------------------+
| FAILED                     | 2        | Transaction execution failed.                                                       |
+----------------------------+----------+-------------------------------------------------------------------------------------+
| MINED                      | 3        | The transaction was successfully executed and successfully packaged into a block.   |
+----------------------------+----------+-------------------------------------------------------------------------------------+
| CONFLICT                   | 4        | When executed in parallel, there are conflicts with other transactions.             |
+----------------------------+----------+-------------------------------------------------------------------------------------+
| PENDING\_VALIDATION        | 5        | The transaction is waiting for validation.                                          |
+----------------------------+----------+-------------------------------------------------------------------------------------+
| NODE\_VALIDATION\_FAILED   | 6        | Transaction validation failed.                                                      |
+----------------------------+----------+-------------------------------------------------------------------------------------+


Implementation
--------------

It is assumed here that there is only one organization in a contract,
that is, there is no need to specifically define the Organization type.
Since the organization is not explicitly declared and created, the
organization’s proposal whitelist does not exist. The process here is
that the voter must use a certain token to vote.

For simplicity, only the core methods CreateProposal, Approve, Reject,
Abstain, and Release are implemented here.

There are only two necessary State attributes:

.. code:: c#

   public MappedState<Hash, ProposalInfo> Proposals { get; set; }
   public SingletonState<ProposalReleaseThreshold> ProposalReleaseThreshold { get; set; }

The Proposals stores all proposal’s information, and the
ProposalReleaseThreshold is used to save the requirements that the
contract needs to meet to release the proposal.

When the contract is initialized, the proposal release requirements
should be set:

.. code:: c#

   public override Empty Initialize(Empty input)
   {
       State.TokenContract.Value =
           Context.GetContractAddressByName(SmartContractConstants.TokenContractSystemName);
       State.ProposalReleaseThreshold.Value = new ProposalReleaseThreshold
       {
           MinimalApprovalThreshold = 1,
           MinimalVoteThreshold = 1
       };
       return new Empty();
   }

The requirement is at least one member who vote and at least one
approval. Create proposal:

.. code:: c#

   public override Hash CreateProposal(CreateProposalInput input)
   {
       var proposalId = Context.GenerateId(Context.Self, input.Token);
       Assert(State.Proposals[proposalId] == null, "Proposal with same token already exists.");
       State.Proposals[proposalId] = new ProposalInfo
       {
           ProposalId = proposalId,
           Proposer = Context.Sender,
           ContractMethodName = input.ContractMethodName,
           Params = input.Params,
           ExpiredTime = input.ExpiredTime,
           ToAddress = input.ToAddress,
           ProposalDescriptionUrl = input.ProposalDescriptionUrl
       };
       return proposalId;
   }

Vote:

.. code:: c#

   public override Empty Abstain(Hash input)
   {
       Charge();
       var proposal = State.Proposals[input];
       if (proposal == null)
       {
           throw new AssertionException("Proposal not found.");
       }
       proposal.Abstentions.Add(Context.Sender);
       State.Proposals[input] = proposal;
       return new Empty();
   }
   public override Empty Approve(Hash input)
   {
       Charge();
       var proposal = State.Proposals[input];
       if (proposal == null)
       {
           throw new AssertionException("Proposal not found.");
       }
       proposal.Approvals.Add(Context.Sender);
       State.Proposals[input] = proposal;
       return new Empty();
   }
   public override Empty Reject(Hash input)
   {
       Charge();
       var proposal = State.Proposals[input];
       if (proposal == null)
       {
           throw new AssertionException("Proposal not found.");
       }
       proposal.Rejections.Add(Context.Sender);
       State.Proposals[input] = proposal;
       return new Empty();
   }
   private void Charge()
   {
       State.TokenContract.TransferFrom.Send(new TransferFromInput
       {
           From = Context.Sender,
           To = Context.Self,
           Symbol = Context.Variables.NativeSymbol,
           Amount = 1_00000000
       });
   }

Release is just count the vote, here is a recommended implementation:

.. code:: c#

   public override Empty Release(Hash input)
   {
       var proposal = State.Proposals[input];
       if (proposal == null)
       {
           throw new AssertionException("Proposal not found.");
       }
       Assert(IsReleaseThresholdReached(proposal), "Didn't reach release threshold.");
       Context.SendInline(proposal.ToAddress, proposal.ContractMethodName, proposal.Params);
       return new Empty();
   }
   private bool IsReleaseThresholdReached(ProposalInfo proposal)
   {
       var isRejected = IsProposalRejected(proposal);
       if (isRejected)
           return false;
       var isAbstained = IsProposalAbstained(proposal);
       return !isAbstained && CheckEnoughVoteAndApprovals(proposal);
   }
   private bool IsProposalRejected(ProposalInfo proposal)
   {
       var rejectionMemberCount = proposal.Rejections.Count;
       return rejectionMemberCount > State.ProposalReleaseThreshold.Value.MaximalRejectionThreshold;
   }
   private bool IsProposalAbstained(ProposalInfo proposal)
   {
       var abstentionMemberCount = proposal.Abstentions.Count;
       return abstentionMemberCount > State.ProposalReleaseThreshold.Value.MaximalAbstentionThreshold;
   }
   private bool CheckEnoughVoteAndApprovals(ProposalInfo proposal)
   {
       var approvedMemberCount = proposal.Approvals.Count;
       var isApprovalEnough =
           approvedMemberCount >= State.ProposalReleaseThreshold.Value.MinimalApprovalThreshold;
       if (!isApprovalEnough)
           return false;
       var isVoteThresholdReached =
           proposal.Abstentions.Concat(proposal.Approvals).Concat(proposal.Rejections).Count() >=
           State.ProposalReleaseThreshold.Value.MinimalVoteThreshold;
       return isVoteThresholdReached;
   }

Test
----

Before testing, two methods were added to a Dapp contract. We will test
the proposal with these methods.

Define a singleton string and an organization address state in the State
class:

.. code:: c#

   public StringState Slogan { get; set; }
   public SingletonState<Address> Organization { get; set; }

A pair of Set/Get methods:

.. code:: c#

   public override StringValue GetSlogan(Empty input)
   {
       return State.Slogan.Value == null ? new StringValue() : new StringValue {Value = State.Slogan.Value};
   }

   public override Empty SetSlogan(StringValue input)
   {
       Assert(Context.Sender == State.Organization.Value, "No permission.");
       State.Slogan.Value = input.Value;
       return new Empty();
   }

In this way, during the test, create a proposal for the SetSlogan. After
passing and releasing, use the GetSlogan method to check whether the
Slogan has been modified.

Prepare a Stub that implements the ACS3 contract:

.. code:: c#

   var keyPair = SampleECKeyPairs.KeyPairs[0];
   var acs3DemoContractStub =
       GetTester<ACS3DemoContractContainer.ACS3DemoContractStub>(DAppContractAddress, keyPair);

Since approval requires the contract to charge users, the user should
send Approve transaction of the Token contract.

.. code:: c#

   var tokenContractStub =
       GetTester<TokenContractContainer.TokenContractStub>(
           GetAddress(TokenSmartContractAddressNameProvider.StringName), keyPair);
   await tokenContractStub.Approve.SendAsync(new ApproveInput
   {
       Spender = DAppContractAddress,
       Symbol = "ELF",
       Amount = long.MaxValue
   });

Create a proposal, the target method is SetSlogan, here we want to
change the Slogan to “AElf” :

.. code:: c#

   var proposalId = (await acs3DemoContractStub.CreateProposal.SendAsync(new CreateProposalInput
   {
       OrganizationAddress = OrganizationAddress
       ContractMethodName = nameof(acs3DemoContractStub.SetSlogan),
       ToAddress = DAppContractAddress,
       ExpiredTime = TimestampHelper.GetUtcNow().AddHours(1),
       Params = new StringValue {Value = "AElf"}.ToByteString(),
       Token = HashHelper.ComputeFrom("AElf")
   })).Output;

Make sure that the Slogan is still an empty string at this time and then
vote:

.. code:: c#

   // Check slogan
   {
       var slogan = await acs3DemoContractStub.GetSlogan.CallAsync(new Empty());
       slogan.Value.ShouldBeEmpty();
   }
   await acs3DemoContractStub.Approve.SendAsync(proposalId);

Release proposal, and the Slogan becomes “AElf”.

.. code:: c#

   await acs3DemoContractStub.Release.SendAsync(proposalId);
   // Check slogan
   {
       var slogan = await acs3DemoContractStub.GetSlogan.CallAsync(new Empty());
       slogan.Value.ShouldBe("AElf");
   }
